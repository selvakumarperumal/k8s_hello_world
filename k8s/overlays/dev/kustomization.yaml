# ==============================================================================
# Kustomize Dev Overlay
# ==============================================================================
#
# WHAT IS AN OVERLAY?
# -------------------
# An overlay is a kustomization that modifies another kustomization (base).
# It lets you customize resources for specific environments without
# duplicating YAML files.
#
# OVERLAY CAPABILITIES:
# ---------------------
# 1. Change namespace      - Put resources in a specific namespace
# 2. Add name prefixes     - Prefix all resource names (e.g., "dev-")
# 3. Override images       - Use different container images
# 4. Patch resources       - Modify specific fields
# 5. Add/remove resources  - Include environment-specific manifests
#
# DEV ENVIRONMENT STRATEGY:
# -------------------------
# - Lower resource allocation (cost savings)
# - Fewer replicas (1 instead of 2-3)
# - SPOT instances acceptable (via Terraform)
# - Shorter log retention
#
# HOW TO USE:
# -----------
# # Preview generated manifests:
# kubectl kustomize k8s/overlays/dev/
#
# # Apply to cluster:
# kubectl apply -k k8s/overlays/dev/
#
# # Delete all resources:
# kubectl delete -k k8s/overlays/dev/
#
# ==============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# -----------------------------------------------------------------
# REFERENCE TO BASE
# -----------------------------------------------------------------
# Include all resources from the base kustomization
# Path is relative to this file
resources:
  - ../../base

# -----------------------------------------------------------------
# NAMESPACE
# -----------------------------------------------------------------
# All resources will be created in this namespace
# Creates logical isolation from other environments
namespace: fastapi-dev

# -----------------------------------------------------------------
# NAME PREFIX
# -----------------------------------------------------------------
# Adds this prefix to all resource names
# e.g., "fastapi-deployment" becomes "dev-fastapi-deployment"
namePrefix: dev-

# -----------------------------------------------------------------
# COMMON LABELS
# -----------------------------------------------------------------
# Additional labels for this environment
# Added to all resources on top of base labels
commonLabels:
  environment: dev

# -----------------------------------------------------------------
# IMAGE TRANSFORMATION
# -----------------------------------------------------------------
# Override the container image without modifying base files
# IMPORTANT: Replace ACCOUNT_ID with your AWS account ID!
images:
  - name: fastapi-hello                                    # Original image name
    newName: ACCOUNT_ID.dkr.ecr.ap-south-1.amazonaws.com/fastapi-eks-dev  # ECR URL
    newTag: latest                                         # Image tag

# -----------------------------------------------------------------
# STRATEGIC MERGE PATCHES
# -----------------------------------------------------------------
# Modify specific fields in existing resources
# This uses JSON/YAML patch format
patches:
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: fastapi-deployment      # Must match base resource name
      spec:
        replicas: 1                   # Override: 1 replica for dev (was 2)
        template:
          spec:
            containers:
              - name: fastapi
                env:
                  - name: ENVIRONMENT
                    value: "development"        # Override environment variable
                resources:
                  requests:
                    cpu: "50m"                  # Lower CPU request
                    memory: "64Mi"              # Lower memory request
                  limits:
                    cpu: "200m"                 # Lower CPU limit
                    memory: "128Mi"             # Lower memory limit
