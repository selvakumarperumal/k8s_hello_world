# ==============================================================================
# Prometheus Operator - kube-prometheus-stack Helm Values
# ==============================================================================
#
# This file configures the kube-prometheus-stack Helm chart which includes:
# - Prometheus Server
# - Alertmanager
# - Grafana
# - Node Exporter
# - kube-state-metrics
#
# INSTALLATION:
# -------------
# helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
# helm install prometheus prometheus-community/kube-prometheus-stack \
#   --namespace monitoring \
#   --create-namespace \
#   -f infrastructure/monitoring/kube-prometheus-stack-values.yaml
#
# ==============================================================================

# Global settings
global:
  # Evaluation interval for Prometheus rules
  evaluation_interval: 30s
  # Scrape interval
  scrape_interval: 30s

# Prometheus server configuration
prometheus:
  prometheusSpec:
    # Resource limits
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

    # Data retention
    retention: 15d
    retentionSize: "10GB"

    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi

    # Service Monitor selector - match all ServiceMonitors
    serviceMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}

    # Pod Monitor selector
    podMonitorSelectorNilUsesHelmValues: false
    podMonitorSelector: {}

# Alertmanager configuration
alertmanager:
  enabled: true
  alertmanagerSpec:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi

  # Alert receivers configuration (customize as needed)
  # config:
  #   route:
  #     receiver: 'slack'
  #     group_by: ['alertname', 'severity']
  #   receivers:
  #     - name: 'slack'
  #       slack_configs:
  #         - channel: '#alerts'
  #           api_url: 'https://hooks.slack.com/services/xxx'

# Grafana configuration
grafana:
  enabled: true

  # Admin credentials
  adminUser: admin
  # adminPassword: Set via --set or secrets

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Persistence
  persistence:
    enabled: true
    size: 5Gi

  # Default dashboards
  defaultDashboardsEnabled: true
  defaultDashboardsTimezone: utc

  # Additional data sources (optional)
  # additionalDataSources: []

  # Service type for access
  service:
    type: ClusterIP
    # type: LoadBalancer  # For external access

# kube-state-metrics configuration
kube-state-metrics:
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 128Mi

# Node exporter configuration
prometheus-node-exporter:
  resources:
    requests:
      cpu: 50m
      memory: 30Mi
    limits:
      cpu: 100m
      memory: 50Mi

# Disable components not needed for EKS (control plane is managed)
kubeControllerManager:
  enabled: false
kubeScheduler:
  enabled: false
kubeEtcd:
  enabled: false
kubeProxy:
  enabled: false

# Enable default rules
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false # Managed by AWS
    general: true
    k8s: true
    kubeApiserver: true
    kubeApiserverAvailability: true
    kubeApiserverSlos: true
    kubelet: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeScheduler: false # Managed by AWS
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true
