# =============================================================================
# Security Scanning Workflow
# =============================================================================
# This workflow performs security scans on the codebase, dependencies,
# and infrastructure as code configurations.
# =============================================================================

name: Security Scan

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main
    schedule:
        # Run weekly security scan
        - cron: "0 0 * * 0"
    workflow_dispatch:

jobs:
    # ---------------------------------------------------------------------------
    # Dependency Scanning
    # ---------------------------------------------------------------------------
    dependency-scan:
        name: Dependency Scan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install dependencies
              run: |
                  pip install safety pip-audit
                  pip install -r app/requirements.txt

            - name: Run pip-audit
              run: pip-audit --format=json --output=pip-audit-results.json
              continue-on-error: true

            - name: Run Safety Check
              run: safety check --json > safety-results.json 2>&1 || true

            - name: Upload scan results
              uses: actions/upload-artifact@v4
              with:
                  name: dependency-scan-results
                  path: |
                      pip-audit-results.json
                      safety-results.json

    # ---------------------------------------------------------------------------
    # Secret Scanning
    # ---------------------------------------------------------------------------
    secret-scan:
        name: Secret Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Run Gitleaks
              uses: gitleaks/gitleaks-action@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ---------------------------------------------------------------------------
    # Infrastructure Security Scan
    # ---------------------------------------------------------------------------
    iac-scan:
        name: IaC Security Scan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Checkov on Terraform
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: infrastructure
                  framework: terraform
                  output_format: sarif
                  output_file_path: terraform-checkov.sarif
                  soft_fail: true

            - name: Run Checkov on Kubernetes/Helm
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: helm
                  framework: helm
                  output_format: sarif
                  output_file_path: helm-checkov.sarif
                  soft_fail: true

            - name: Upload Terraform results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: terraform-checkov.sarif
                  category: terraform

            - name: Upload Helm results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: helm-checkov.sarif
                  category: helm

    # ---------------------------------------------------------------------------
    # Container Security Scan
    # ---------------------------------------------------------------------------
    container-scan:
        name: Container Scan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Build Docker image for scanning
              run: |
                  docker build -t fastapi-app:scan ./app

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "fastapi-app:scan"
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH,MEDIUM"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Run Dockerfile linting
              uses: hadolint/hadolint-action@v3.1.0
              with:
                  dockerfile: app/Dockerfile
                  failure-threshold: warning

    # ---------------------------------------------------------------------------
    # Security Summary
    # ---------------------------------------------------------------------------
    security-summary:
        name: Generate Security Summary
        runs-on: ubuntu-latest
        needs: [dependency-scan, secret-scan, iac-scan, container-scan]
        if: always()

        steps:
            - name: Generate Summary
              run: |
                  echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| IaC Scan | ${{ needs.iac-scan.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Container Scan | ${{ needs.container-scan.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
