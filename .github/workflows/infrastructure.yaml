# =============================================================================
# Infrastructure Deployment Workflow
# =============================================================================
# This workflow manages Terraform infrastructure deployment for EKS.
# Supports plan, apply, and destroy operations.
# =============================================================================

name: Infrastructure Deployment

on:
    push:
        branches:
            - main
        paths:
            - "infrastructure/**"
            - ".github/workflows/infrastructure.yaml"
    pull_request:
        branches:
            - main
        paths:
            - "infrastructure/**"
    workflow_dispatch:
        inputs:
            action:
                description: "Terraform action to perform"
                required: true
                default: "plan"
                type: choice
                options:
                    - plan
                    - apply
                    - destroy
            environment:
                description: "Environment to deploy"
                required: true
                default: "dev"
                type: choice
                options:
                    - dev
                    - staging
                    - prod

env:
    AWS_REGION: ap-south-1
    TF_VERSION: 1.6.6

jobs:
    # ---------------------------------------------------------------------------
    # Terraform Validation and Security Scan
    # ---------------------------------------------------------------------------
    validate:
        name: Validate and Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Terraform Format Check
              id: fmt
              run: terraform fmt -check -recursive
              working-directory: infrastructure
              continue-on-error: true

            - name: Terraform Init
              id: init
              run: terraform init -backend=false
              working-directory: infrastructure

            - name: Terraform Validate
              id: validate
              run: terraform validate
              working-directory: infrastructure

            - name: Run Checkov Security Scan
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: infrastructure
                  framework: terraform
                  output_format: sarif
                  output_file_path: checkov-results.sarif
                  soft_fail: true

            - name: Upload Checkov results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: checkov-results.sarif

            - name: Post validation summary
              run: |
                  echo "## Terraform Validation Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Format | ${{ steps.fmt.outcome == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Init | ${{ steps.init.outcome == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Validate | ${{ steps.validate.outcome == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY

    # ---------------------------------------------------------------------------
    # Terraform Plan
    # ---------------------------------------------------------------------------
    plan:
        name: Terraform Plan
        runs-on: ubuntu-latest
        needs: validate
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              run: terraform init
              working-directory: infrastructure

            - name: Terraform Plan
              id: plan
              run: |
                  terraform plan -out=tfplan -no-color 2>&1 | tee plan_output.txt
              working-directory: infrastructure
              continue-on-error: true

            - name: Post Plan to PR
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request'
              with:
                  script: |
                      const fs = require('fs');
                      const plan = fs.readFileSync('infrastructure/plan_output.txt', 'utf8');
                      const maxLength = 65000;
                      const truncatedPlan = plan.length > maxLength 
                        ? plan.substring(0, maxLength) + '\n... (truncated)'
                        : plan;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `## Terraform Plan Output

                      <details>
                      <summary>Click to expand</summary>

                      \`\`\`hcl
                      ${truncatedPlan}
                      \`\`\`

                      </details>`
                      });

            - name: Upload Plan Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: tfplan
                  path: infrastructure/tfplan
                  retention-days: 5

            - name: Check Plan Status
              if: steps.plan.outcome == 'failure'
              run: exit 1

    # ---------------------------------------------------------------------------
    # Terraform Apply
    # ---------------------------------------------------------------------------
    apply:
        name: Terraform Apply
        runs-on: ubuntu-latest
        needs: plan
        if: |
            (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply') ||
            (github.event_name == 'push' && github.ref == 'refs/heads/main')
        environment:
            name: ${{ github.event.inputs.environment || 'dev' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Download Plan Artifact
              uses: actions/download-artifact@v4
              with:
                  name: tfplan
                  path: infrastructure

            - name: Terraform Init
              run: terraform init
              working-directory: infrastructure

            - name: Terraform Apply
              run: terraform apply -auto-approve tfplan
              working-directory: infrastructure

            - name: Get Outputs
              id: outputs
              run: |
                  echo "cluster_name=$(terraform output -raw cluster_name)" >> $GITHUB_OUTPUT
                  echo "ecr_repository_url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT
              working-directory: infrastructure

            - name: Post Apply Summary
              run: |
                  echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Cluster Name:** \`${{ steps.outputs.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**ECR Repository:** \`${{ steps.outputs.outputs.ecr_repository_url }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Configure kubectl" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ steps.outputs.outputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    # ---------------------------------------------------------------------------
    # Terraform Destroy
    # ---------------------------------------------------------------------------
    destroy:
        name: Terraform Destroy
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
        environment:
            name: ${{ github.event.inputs.environment }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              run: terraform init
              working-directory: infrastructure

            - name: Terraform Destroy
              run: terraform destroy -auto-approve
              working-directory: infrastructure

            - name: Post Destroy Summary
              run: |
                  echo "## Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "⚠️ All infrastructure resources have been destroyed." >> $GITHUB_STEP_SUMMARY
