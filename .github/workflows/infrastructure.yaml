# =============================================================================
# Infrastructure GitHub Actions Workflow
# =============================================================================
# This workflow manages the main EKS infrastructure (VPC, EKS, ECR).
# It uses remote state stored in S3 (created by bootstrap workflow).
#
# Prerequisites:
#   1. Run bootstrap workflow first to create S3/DynamoDB
#   2. Ensure backend.hcl is updated with correct values
#
# Triggers:
#   - Manual dispatch with plan/apply/destroy action
#   - Push to main on infrastructure changes
#   - Pull requests for plan preview
# =============================================================================

name: Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Terraform action to perform"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: plan
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev

  push:
    branches:
      - main
    paths:
      - "infrastructure/*.tf"
      - "infrastructure/*.tfvars"
      - "infrastructure/backend.hcl"
      - "!infrastructure/bootstrap/**"

  pull_request:
    branches:
      - main
    paths:
      - "infrastructure/*.tf"
      - "infrastructure/*.tfvars"
      - "!infrastructure/bootstrap/**"

env:
  TF_VERSION: "1.6.6"
  AWS_REGION: "ap-south-1"
  WORKING_DIR: "infrastructure"

jobs:
  # ---------------------------------------------------------------------------
  # Security Scan
  # ---------------------------------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infrastructure
          framework: terraform
          output_format: sarif
          output_file_path: results.sarif
          soft_fail: true
          skip_check: CKV_AWS_144,CKV_AWS_145 # Skip cross-region replication checks

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  # ---------------------------------------------------------------------------
  # Terraform Plan
  # ---------------------------------------------------------------------------
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      plan_exit_code: ${{ steps.plan.outputs.exitcode }}
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Format Check
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -backend-config=backend.hcl

      - name: Terraform Validate
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -out=tfplan \
            -input=false \
            -detailed-exitcode || echo "exitcode=$?" >> $GITHUB_OUTPUT

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: infra-tfplan
          path: ${{ env.WORKING_DIR }}/tfplan
          retention-days: 5

      - name: Create Plan Summary
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          terraform show -no-color tfplan >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Plan details not available" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `## Terraform Plan Results

            **Action:** \`plan\`
            **Working Directory:** \`${{ env.WORKING_DIR }}\`
            **Triggered by:** @${{ github.actor }}

            <details>
            <summary>Show Plan</summary>

            \`\`\`terraform
            ${{ steps.plan.outputs.stdout || 'Plan completed successfully' }}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ---------------------------------------------------------------------------
  # Terraform Apply
  # ---------------------------------------------------------------------------
  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: plan
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.cluster_info.outputs.cluster_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -backend-config=backend.hcl

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: infra-tfplan
          path: ${{ env.WORKING_DIR }}

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -auto-approve tfplan

      - name: Get Cluster Info
        id: cluster_info
        working-directory: ${{ env.WORKING_DIR }}
        continue-on-error: true
        run: |
          echo "## Infrastructure Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| VPC ID | $(terraform output -raw vpc_id) |" >> $GITHUB_STEP_SUMMARY
          echo "| EKS Cluster | $(terraform output -raw cluster_name) |" >> $GITHUB_STEP_SUMMARY
          echo "| ECR Repository | $(terraform output -raw ecr_repository_url) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### kubectl Configuration" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          terraform output -raw configure_kubectl >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "cluster_url=https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters/$(terraform output -raw cluster_name)" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Terraform Destroy
  # ---------------------------------------------------------------------------
  destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy'
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}-destroy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -backend-config=backend.hcl

      - name: Delete Load Balancers
        continue-on-error: true
        run: |
          echo "Cleaning up Load Balancers..."
          CLUSTER_NAME=$(terraform -chdir=${{ env.WORKING_DIR }} output -raw cluster_name 2>/dev/null || echo "")
          if [ -n "$CLUSTER_NAME" ]; then
            # Get VPC ID
            VPC_ID=$(terraform -chdir=${{ env.WORKING_DIR }} output -raw vpc_id 2>/dev/null || echo "")
            if [ -n "$VPC_ID" ]; then
              # Delete ELBs in the VPC
              for elb in $(aws elb describe-load-balancers --query "LoadBalancerDescriptions[?VPCId=='$VPC_ID'].LoadBalancerName" --output text); do
                echo "Deleting ELB: $elb"
                aws elb delete-load-balancer --load-balancer-name $elb || true
              done
              # Delete ALBs in the VPC
              for alb in $(aws elbv2 describe-load-balancers --query "LoadBalancers[?VpcId=='$VPC_ID'].LoadBalancerArn" --output text); do
                echo "Deleting ALB: $alb"
                aws elbv2 delete-load-balancer --load-balancer-arn $alb || true
              done
            fi
          fi

      - name: Empty ECR Repository
        continue-on-error: true
        run: |
          REPO_NAME=$(terraform -chdir=${{ env.WORKING_DIR }} output -raw ecr_repository_name 2>/dev/null || echo "")
          if [ -n "$REPO_NAME" ]; then
            echo "Emptying ECR repository: $REPO_NAME"
            aws ecr batch-delete-image \
              --repository-name $REPO_NAME \
              --image-ids "$(aws ecr list-images --repository-name $REPO_NAME --query 'imageIds[*]' --output json)" || true
          fi

      - name: Wait for Resources Cleanup
        run: sleep 60

      - name: Terraform Destroy
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          terraform destroy \
            -var-file=terraform.tfvars \
            -auto-approve

      - name: Cleanup Summary
        run: |
          echo "## Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All infrastructure resources have been destroyed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** The bootstrap resources (S3 bucket, DynamoDB table) are still available." >> $GITHUB_STEP_SUMMARY
          echo "Run the bootstrap destroy workflow if you want to remove those as well." >> $GITHUB_STEP_SUMMARY
