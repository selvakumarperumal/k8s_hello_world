# ==============================================================================
# GitHub Actions - Deploy to EKS
# ==============================================================================
# Deploys the FastAPI application to EKS using Kustomize.
# MANUAL TRIGGER ONLY - for learning and controlled deployments.
# ==============================================================================

name: Deploy to EKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (dev/test/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod
      image_tag:
        description: 'Docker image tag to deploy (default: latest)'
        required: false
        default: 'latest'
        type: string

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-south-1' }}

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Update kubeconfig
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name fastapi-eks-${{ github.event.inputs.environment }} \
            --region ${{ env.AWS_REGION }}

      # Setup kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0'

      # Create namespace if not exists
      - name: Create namespace
        run: |
          kubectl apply -f k8s/overlays/${{ github.event.inputs.environment }}/namespace.yaml

      # Update kustomization with correct image
      - name: Update kustomization
        run: |
          cd k8s/overlays/${{ github.event.inputs.environment }}
          
          # Get ECR repository URL
          ECR_URL="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/fastapi-eks-${{ github.event.inputs.environment }}"
          
          # Update kustomization.yaml with correct image
          sed -i "s|ACCOUNT_ID.dkr.ecr.ap-south-1.amazonaws.com/fastapi-eks-${{ github.event.inputs.environment }}|${ECR_URL}|g" kustomization.yaml
          sed -i "s|newTag: latest|newTag: ${{ github.event.inputs.image_tag }}|g" kustomization.yaml
          
          cat kustomization.yaml

      # Deploy using Kustomize
      - name: Deploy with Kustomize
        run: |
          kubectl apply -k k8s/overlays/${{ github.event.inputs.environment }}

      # Wait for deployment rollout
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/${{ github.event.inputs.environment }}-fastapi-deployment \
            -n fastapi-${{ github.event.inputs.environment }} \
            --timeout=300s

      # Get deployment status
      - name: Get deployment status
        run: |
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pods:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n fastapi-${{ github.event.inputs.environment }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n fastapi-${{ github.event.inputs.environment }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # Output access instructions
      - name: Access Instructions
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Access Your Application" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Port Forward Command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward service/${{ github.event.inputs.environment }}-fastapi-service 8000:80 -n fastapi-${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Then visit: http://localhost:8000" >> $GITHUB_STEP_SUMMARY
